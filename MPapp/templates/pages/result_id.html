{% import 'macros.html' as macros %}
{% extends "base.html" %}
{% block header %}
{% endblock %}
{% block content %}
{% if status == "OK" %}
<head>
  <scripts>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sofia+Sans:wght@300&display=swap" rel="stylesheet">
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" integrity="sha512-tS3S5qG0BlhnQROyJXvNjeEM4UpMXHrQfTGmbQ1gKmelCxlSEBUaxhRBj/EFTzpbP4RVSrpEikbmdJobCvhE3g==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" integrity="sha512-sMXtMNL1zRzolHYKEujM2AqCLUR9F2C4/05cdbxjjLSRvMQIciEPCQZo++nk7go3BtSuK9kfa/s+a4f4i5pLkw==" crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" integrity="sha512-sMXtMNL1zRzolHYKEujM2AqCLUR9F2C4/05cdbxjjLSRvMQIciEPCQZo++nk7go3BtSuK9kfa/s+a4f4i5pLkw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/igv@2.13.9/dist/igv.min.js"></script>
<script>


function setup() {
    var canvasDiv = document.getElementById('canvasForHTML');
    var width = canvasDiv.offsetWidth;
    var sketchCanvas = createCanvas(width,height);
   
    sketchCanvas.parent("canvasForHTML");
} 
PfMaxLength = 3300000
var chromWidth

var pfLengthsDict = {
  "1" : 643000,"2" : 947000,"3" : 1100000,"4" : 1200000,
  "5" : 1300000,  "6" : 1400000,"7" : 1400000,"8" : 1300000,
  "9" : 1500000,"10" : 1700000,  "11" : 2000000,"12" : 2300000,
  "13" : 2700000,"14" : 3300000
}

function drawChrom(chroma) {
  clear()
  noStroke();
let c = color(255,89,0)
fill(c)
var chromaLength = 0

if( pfLengthsDict.hasOwnProperty(chroma) ) {
    chromaLength = pfLengthsDict[chroma];
    
}
chromWidth = chromaLength/PfMaxLength * 100;

var length = width/1.5
var total = chromWidth / 100 * length
  rect(width/3.5, 10, total,height/2, 25);
drawPositions(chroma,chromaLength,total)
}
function drawPositions(chroma,length,total){
  var chromosomeNumber = 0
 
for (var k in dict) {
        if ( k.indexOf(chroma) !== -1) 
            chromosomeNumber = dict[k]
    }
    for( var val =0; val<chromosomeNumber.length;val++){
      var percentage = (chromosomeNumber[val] * 100) / length ;
      var currPos = percentage /100 * total

      stroke(0)
 strokeWeight(2);
 
 line(currPos+width/3.5,11,currPos+width/3.5,height/1.7)
    }
  
    
    
    
    
  
}

</script>
    
    <script type="text/javascript">
      am5.ready(function() {


var root = am5.Root.new("chartdiv");


root.setThemes([
  am5themes_Animated.new(root)
]);


var chart = root.container.children.push(am5map.MapChart.new(root, {
  panX: "rotateX",
  panY: "rotateY",
  projection: am5map.geoOrthographic(),
  paddingBottom: 20,
  paddingTop: 20,
  paddingLeft: 20,
  paddingRight: 20
}));

var cont = chart.children.push(
  am5.Container.new(root, {
    layout: root.horizontalLayout,
    x: 20,
    y: 40
  })
);


var backgroundSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));

backgroundSeries.mapPolygons.template.setAll({
  fill: am5.color("#2B65EC"),
  fillOpacity: 0.5,
  strokeOpacity: 0
});
backgroundSeries.data.push({
  geometry:
    am5map.getGeoRectangle(90, 180, -90, -180)
});
// Create main polygon series for countries

var polygonSeries = chart.series.push(
  am5map.MapPolygonSeries.new(root, {
    geoJSON: am5geodata_worldLow,
   
  })
);

polygonSeries.mapPolygons.template.setAll({
  fill: am5.color("#eee"),
  
  strokeWidth: 0.5,
  stroke: root.interfaceColors.get("background")
});



var pointSeries = chart.series.push(am5map.MapPointSeries.new(root, {}));
var colorset = am5.ColorSet.new(root, {});

pointSeries.bullets.push(function () {
  var container = am5.Container.new(root, {});

  var circle = container.children.push(
    am5.Circle.new(root, {
      radius: 8,
      tooltipY: 0,
      fill: am5.color(0xff0000),
      strokeOpacity: 0,
      tooltipText: "{title}"
    })
  );

  var circle2 = container.children.push(
    am5.Circle.new(root, {
      radius:14,
      tooltipY: 0,
      fill: am5.color(0xff0000),
      strokeOpacity: 0,
      tooltipText: "{title}"
    })
  );

  circle.animate({
    key: "scale",
    from: 1,
    to: 4,
    duration: 600,
    easing: am5.ease.out(am5.ease.cubic),
    loops: Infinity
  });
  circle.animate({
    key: "opacity",
    from: 1,
    to: 0,
    duration: 3000,
    easing: am5.ease.out(am5.ease.cubic),
    loops: Infinity
  });

  return am5.Bullet.new(root, {
    sprite: container
  });
});

var regions = [
  
  
];

// Rotate animation
chart.animate({
  key: "rotationX",
  from: 0,
  to: 360,
  duration: 6000,
  loops: Infinity
});
$(document).ready(function(){
 
 
  var region = $('#region').data();
var regionalValues = Object.values(region);

firstValue = regionalValues[0]
var splitValues = firstValue.split(":")
beforeTrim = splitValues[1];
finalRegion = beforeTrim.replace(/[^\w\s!?]/g,'');

if(finalRegion == " Western Africa" ){
regions.push({
    title: "West Africa",
    latitude: 13,
    longitude: 2
  },)
  
  
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}else if (finalRegion == " Oceania"){

  regions.push({
    title: "Oceania",
    latitude:-15,
    longitude: 140
  },)
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}else if (finalRegion == " Eastern Africa"){
  regions.push({
    title: "East Africa",
    latitude: 14,
    longitude: 33
  },)
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}else if (finalRegion == " Africa"){
  regions.push({
    title: "Africa",
    latitude: 6.6,
    longitude: 21
  },)
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}else if (finalRegion == " Southeast Asia"){
  regions.push({
    title: "Southeast Asia",
    latitude: 7,
    longitude: 111
  },)
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}else if (finalRegion == " Horn of Africa"){
  regions.push({
    title: "Horn of Africa",
    latitude: 7,
    longitude: 43
  },)
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}else if (finalRegion == " South America"){
  regions.push({
    title: "South America",
    latitude: -10,
    longitude: -60
  },)
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}
})


function addregion(longitude, latitude, title) {
  pointSeries.data.push({
    geometry: { type: "Point", coordinates: [longitude, latitude] },
    title: title
  });
}


chart.appear(1000, 100);


}); 

    </script>
   
  </scripts>
  <style>

div#draw-shapes {
  width: 95%;
  height: 600px;
  margin: 2.5% auto;
}
    body{
      background-color: RGB(240,240,240)
    }
    .container-fluid {

   width: 80%;
   background-color: #eee;
   display: grid;
   
  gap:15px ;
   grid-template-columns: repeat(4, 1fr);
   grid-template-rows: repeat(.5fr, 1.5fr,1.5fr,.5fr);
   
   

}

.container-fluid > div{
  box-shadow: 2px 2px 10px ;
  height: auto;
 border-radius: 15px;
  background-color: white;
  
}
.container-fluid > div:nth-child(1){
  padding:20px;
  grid-column: span 4;
  
  font-family: Georgia, 'Times New Roman', Times, serif;

}
.container-fluid > div:nth-child(1) .buttonHere,h4,.date{
  
  display: flex;
  
  justify-content: center; /* center horizontal */
  align-items: center; /* center vertical */
  font-family:'Sofia Sans', sans-serif;
}

 .header{
  border-radius: 15px;
}
.container-fluid > div:nth-child(2){
  
  grid-column: span 1;
  text-align: center;
}

.container-fluid > div:nth-child(3){
  
  grid-column: span 2;
  grid-row: span 2;
}
.container-fluid > div:nth-child(4){
  
  grid-column: span 1;
}
.container-fluid > div:nth-child(5){
  
  grid-column: span 1;
}
.container-fluid > div:nth-child(6){
  
  grid-column: span 1;
  overflow: hidden;
}
.container-fluid > div:nth-child(7){
 
  grid-column: span 4;
  
}
.container-fluid .fa-solid{
            color: rgb(255,89,0);
            margin-top: 5px;
        }

.container2 {
  height: 40%;
  width: 100%;
  display: flex;
  flex-direction: row;
 
}
        .container2 > div:nth-child(1){
  width:80%;
  height: 70%;
  
 
}
.container2 > div:nth-child(2){
  width:80%;
  height: 70%;
  
  margin: 10px;
  
}
.container2 > div:nth-child(3){
  width:80%;
  height: 70%;
  grid-column-start: 1;
  grid-row-start: 3;
 
  margin: 10px;
}
.container2 > div:nth-child(4){
  width:80%;
  height: 70%;
  flex-direction: column;
  margin: 10px;
}
.container3{
  clear: both;
  display: flex;
  flex-direction: column;
  
}
.container4{
  clear: both;
  display: flex;
  float:left;
  width:33%;
  height: inherit;
  flex-direction: column;
}


.resistance .btn-outline-success{
  justify-content: center;
  align-items: center;
  text-align: center;
  font-family: 'Sofia Sans', sans-serif;;
}
.buttonHere{
  display: flex;
  
  justify-content: center; /* center horizontal */
  align-items: center; /* center vertical */
  overflow: hidden;
  width: inherit;
}
.container .btn{
  background-color: rgb(255,89,0);
  border-color: rgb(255,89,0);
  width:50%;
  font-family: 'Sofia Sans', sans-serif;;

}
.item{
width:inherit;
  text-align: center;
}
table {
    table-layout: fixed;
    overflow-y: scroll;
    word-wrap: break-word;
}
.dropdown-menu {
  color: white !important;
  background-color: rgb(74,74,74) !important;
  }

.dropdown-item{
  color: white;
}
#remove2,#remove1,#remove3{
  overflow-y:  scroll;
}
.tabby{
max-height: 400px;
}
  </style>
  

  
</head>
<div class="container-fluid" style="margin-top: 25px;">
  <div class="1">
    <h4><b>RESULT ID: </b> {{run_id}}</h4>
    <div class="date">
      {% for key in tables %}
      {% if key == 'General information' %}
      {{macros.get_results2(tables[key][0], tables[key][1], key)}}
      
      {% endif %}
      {% endfor %}              
    </div>
    <div class="id">
      <form method="get" action="{{ url_for('main.download', run_id=run_id) }}">          
      </div>
      
  </div>
  
  <div class="2">
    <div class="card-header text-center bg-light" style="border-top-left-radius: 15px;border-top-right-radius: 15px;">
      <h4>Species</h4>
    </div>
    {% for key in tables %}
    {% if key == 'Species' %}
    {{macros.get_results(tables[key][0], tables[key][1], key)}}
    
    {% endif %}
    {% endfor %}                 
  </div>
  <div class="3" id="three">
    <div class="card-header text-center bg-light" style="border-top-left-radius: 15px;border-top-right-radius: 15px;">
      <h4>Genomic variants</h4>
    </div>
      <div class="tabby" id="remove1">    
        <div class="tab-content" id="tabcontent">  
          
          {% for key in tables %}     
                {% if key == "Resistance report" %}
                <div class="tab-pane fade show active" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                  {{macros.generic_table(tables[key][0], tables[key][1], key)}}
                </div>       
            
                
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="tabby" id="remove2" style="display:none;">    
        <div class="tab-content" id="tabcontent">  
          
          {% for key in tables %}     
                {% if key == "Other variants" %}
                <div class="tab-pane fade show active" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                  {{macros.generic_table(tables[key][0], tables[key][1], key)}}
                </div>       
            
              
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="tabby" id="remove3" style="display:none;">    
        <div class="tab-content" id="tabcontent">  
          
          {% for key in tables %}     
                {% if key == "Missing positions report" %}
                <div class="tab-pane fade show active" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                  {{macros.generic_table(tables[key][0], tables[key][1], key)}}
                </div>       
            
                
            {% endif %}
          {% endfor %}
        </div>
      </div>
      
        <div class="buttons">
        <span style="display: table;
        margin: 0 auto;">
        {% set values = [] %}

        {% for key in tables %}
    
    {% for row in tables[key][0] %}
    {% if key == 'Resistance variants report' %}
    {{ values.append(row) or "" }}
   {% endif %}
    {% endfor %}
        
{% endfor %}
<meta id="rvr-data" data-name="{{values}}" >
         <a  class="orange btn btn-outline-success btn-lg active" onclick="showDiv('remove1')">RESISTANCE REPORT</a>
       
         {% set values = [] %}
    
         {% for key in tables %}
    
    {% for row in tables[key][0] %}
    {% if key == 'Other variants' %}
    {{ values.append(row) or "" }}
   {% endif %}
    {% endfor %}
        
{% endfor %}
        <meta id="other-data" data-name="{{values}}" >
         <a  class="orange btn btn-outline-success btn-lg"  onclick="showDiv('remove2')">OTHER VARIANTS</a>
         
         {% set values = [] %}
  
        {% for key in tables %}
    
        {% for row in tables[key][0] %}
        {% if key == 'Missing positions report' %}
        {{ values.append(row) or "" }}
       {% endif %}
        {% endfor %}
            
    {% endfor %}
            <meta id="miss-data " data-name="{{values}}" >
         <a  class="orange btn btn-outline-success btn-lg" onclick="showDiv('remove3')">MISSING POSITIONS</a>
        </span>
        </div>
        <div class="moreButtons">
          <span style="display: table;
        margin: 0 auto;">
          <a  data-toggle="modal" data-target=".bd-example-modal-lg" class=" btn btn-outline-success btn-lg" style="margin-top: 10px;" >SHOW MORE INFO</a>
          </span>
        </div>
       
        <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
               <div class="tabb"  >    
                <div class="tab-content" id="tabcontent"> 
                  {% for key in tables %}     
                {% if key == "Resistance variants report" or key == 'Missing positions report' or key == 'Other variants' %}
                <div class="tab-pane fade show active" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                  {{macros.resistanceTable(tables[key][0], tables[key][1], key)}}
                </div> 
                {% endif %}
                {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>   
      
  </div>
  <div class="4">
    <div class="card-header text-center bg-light" style="border-top-left-radius: 15px;border-top-right-radius: 15px;">
      <h4>Estimated Region of Origin</h4>
  </div>
  {% for key in tables %}
    
    {% for row in tables[key][0] %}
    {% if key == 'Geoclassification' %}
    <meta id="region" data-name="{{row}}" >
    <p style="text-align: center; margin-top: 5px; font-family: 'Sofia Sans', sans-serif;">{{row['region']}}</p>
    {% endif %}
    {% endfor %}
    {% endfor %}
    <div id="chartdiv" style="width: 100%; height: 60%; display: flex-box;
    
    justify-content: center; /* center horizontal */
    align-items: center; /* center vertical */
    overflow: hidden;"></div></div>
  <div class="5">
    <div class="card-header text-center bg-light" style="border-top-left-radius: 15px;border-top-right-radius: 15px;">
      <h4>Analysis</h4>
    </div>
    {% for key in tables %}
    {% if key == 'Analysis' %}
    {{macros.get_results(tables[key][0], tables[key][1], key)}}
    
    {% endif %}
    {% endfor %}  
  </div>
  <div class="6">
    <div class="card-header text-center bg-light" style="border-top-left-radius: 15px;border-top-right-radius: 15px;">
      <h4>Coverage report</h4>
    </div>
    <div class="carousel">
      {% for key in tables %}
    {% if key == 'Coverage report' %}
    {{macros.get_analysis(tables[key][0], tables[key][1], key)}}
    
    {% endif %}
    {% endfor %}
    </div>
    </div>
  <div  class="7" id="7"> 

    <div class="igvDiv" id="igvDiv" style="width: 100%; height:auto; overflow: hidden; border-radius: 25px;"></div>
</div>

   
</div>
<section class="button" style="margin-top:50px">
  <div class="container" id="buttonbit">
    <div class="buttonHere">
      <button type="submit" class="btn btn-success btn" name="result_download" id="result_download"><i class="fa fa-download"></i> DOWNLOAD</button>
    </div>
  </div>
  
</section>
&nbsp;
&nbsp;


<script type="text/javascript">

  function showDiv(divId) {
    var divs = document.getElementsByClassName("tabby");
    for (var i = 0; i < divs.length; i++) {
        divs[i].style.display = "none";
    }
    document.getElementById(divId).style.display = "block";
}
  function showGene2(number) {
      var gene = document.getElementById("dropdownMenu"+number).textContent
      var genesArray = gene.split(/\s+/)
   
      gene = genesArray[1]
      protein = genesArray[2]
      changeData("#rvr-data",gene,protein)
  }
  
  function showGene(item,number) {
document.getElementById("dropdownMenu"+number).innerHTML = item.innerHTML;
}
  
function changeData(data,gene,protein){
  
  igv.removeAllBrowsers()
  STATIC_URL = 'static/'
  {# {% load static %} #}
  var djangoData = $(data).data();


  
  var rvrValues = Object.values(djangoData);
  console.log(rvrValues)
  firstValue = rvrValues[0]
  
var splitValues = firstValue.split("{'chrom':")
var chromosomes = []
var chromArray = []
var resistancePosArray = []
for(var i =1; i<splitValues.length;i++){

  var split2 =splitValues[i].split(",")

  if(split2.find(a =>a.includes(protein))){
    chromArray = split2[0].split("_");
    resistancePosArray = split2[1].split(":")

  }
    
  }

var currentChromosome = chromArray[1]
var currentPos = resistancePosArray[1]
if (currentChromosome.includes("0")){
  currentChromosome = currentChromosome.replace('0','')
}else{

}

var initiallocus = "chr"+currentChromosome+":"+currentPos
const locus = initiallocus.replace(/\s+/g, '')
var igvDiv = document.getElementById("igvDiv");
      var options =
        {
          genome:"hg38",
            locus: locus,
            tracks: [
                {
                    "name": gene,
                    "url": "https://s3.amazonaws.com/1000genomes/data/HG00103/alignment/HG00103.alt_bwamem_GRCh38DH.20150718.GBR.low_coverage.cram",
                    "indexURL": "https://s3.amazonaws.com/1000genomes/data/HG00103/alignment/HG00103.alt_bwamem_GRCh38DH.20150718.GBR.low_coverage.cram.crai",
                    "height":"50"
                }
            ]
        };
        igv.createBrowser(igvDiv, options)
                .then(function (browser) {
                })
    }

            


</script>




<script  type=text/javascript>
  $('.orange').click(function(e) {
    e.preventDefault();
  
  $('.orange').removeClass('active');
  $(this).addClass('active');
})
</script>
<script>
  
</script>
<!--
  <div class="row justify-content-center text-center">
    <div class="col-md-6">
      <h4><b>Result ID:</b> {{run_id}}</h4>
        <div id="f3" class="row justify-content-center">
          <form method="get" action="{{ url_for('main.download', run_id=run_id) }}">          
          <button type="submit" class="btn btn-success btn-lg" name="result_download" id="result_download"><i class="fa fa-download"></i> Download</button>
          </form>
        </div>
        <hr>  
    </div>
  </div class="row justify-content-center text-center">
  
  <div class="row justify-content-center text-center">
    <div class="col-md-6">
      <ul class="nav nav-tabs" id="nav-tab" role="tablist">
        {% for key in tables %}
          {% if tables[key] != None %}
            {% set keyname = key.replace(' ', '') %}
              <li class="nav-item" role="presentation">
                {% if loop.index0 == 0 %}                    
                  <a class="nav-link active" id="{{ keyname }}-tab" data-toggle="tab" href="#{{ keyname }}-tabs" role="tab" aria-controls="{{ keyname }}-tabs" aria-selected="true">{{key}}</a>
                {% else %}
                  <a class="nav-link" id="{{ keyname }}-tab" data-toggle="tab" href="#{{ keyname }}-tabs" role="tab" aria-controls="{{ keyname }}-tabs" aria-selected="false">{{key}}</a>
                {% endif %}
              </li>
          {% endif %}            
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="row justify-content-center text-center">
    <div class="col-md-6">    
      <div class="tab-content" id="tabcontent">  
        {% for key in tables %}     
          {% if tables[key] != None %}         
            {% set keyname = key.replace(' ', '') %}
            {% if loop.index0 == 0 %}  
              <div class="tab-pane fade show active" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                {{macros.generic_table(tables[key][0], tables[key][1], key)}}
              </div>       
            {% elif loop.index0 != 0 %}
            <div class="tab-pane fade" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                {{macros.generic_table(tables[key][0], tables[key][1], key)}}
              </div>  
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>    
  </div>
  
{% elif status == "Processing" %}
  <div class="row justify-content-center">
    <div class="loader"></div>
  </div>
  <div class="row justify-content-center">
    <h4 id="resultid">{{run_id}}</h4>

  -->
  
  <script>

    setTimeout(function(){
        window.location.reload(1);
    }, 5000);
  </script> 

{% endif %}
{% endblock %}