{% import 'macros.html' as macros %}
{% extends "base.html" %}
{% block header %}
{% endblock %}
{% block content %}
{% if status == "OK" %}
<head>
  <scripts>
    
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.js"></script>
<script>


function setup() {
    var canvasDiv = document.getElementById('canvasForHTML');
    var width = canvasDiv.offsetWidth;
    var sketchCanvas = createCanvas(width,height);
   
    sketchCanvas.parent("canvasForHTML");
} 
PfMaxLength = 3300000
var chromWidth

var lengthDict = {
  "PfChrom1Length" : 643000,"PfChrom2Length" : 947000,"PfChrom3Length" : 1100000,"PfChrom4Length" : 1200000,
  "PfChrom5Length" : 1300000,  "PfChrom6Length" : 1400000,"PfChrom7Length" : 1400000,"PfChrom8Length" : 1300000,
  "PfChrom9Length" : 1500000,"PfChrom10Length" : 1700000,  "PfChrom11Length" : 2000000,"PfChrom12Length" : 2300000,
  "PfChrom13Length" : 2700000,"PfChrom14Length" : 3300000
}

function drawChrom(chroma) {
  clear()
  noStroke();
let c = color(0, 104, 107);
fill(c)
var chromaLength = 0
for (var k in lengthDict) {
        if ( k.indexOf(chroma) !== -1) 
            chromaLength = lengthDict[k]
    }
chromWidth = chromaLength/PfMaxLength * 100;
var length = width/1.5
var total = chromWidth / 100 * length
  rect(0, 10, total,height/2, 25);
drawPositions(chroma,chromaLength,total)
}
function drawPositions(chroma,length,total){
  var chromosomeNumber = 0
  let c = color(255, 204, 0);
  fill(c)
  for (var k in dict) {
        if ( k.indexOf(chroma) !== -1) 
            chromosomeNumber = dict[k]
    }
    for( var val =0; val<chromosomeNumber.length;val++){
      var percentage = (chromosomeNumber[val] * 100) / length ;
      var currPos = percentage /100 * total

      stroke(0)
 strokeWeight(2);

 line(currPos,11,currPos,height/1.7)
    }
  
    
    
    
    
  
}

</script>
    
    <script type="text/javascript">
      am5.ready(function() {


var root = am5.Root.new("chartdiv");


root.setThemes([
  am5themes_Animated.new(root)
]);


var chart = root.container.children.push(am5map.MapChart.new(root, {
  panX: "rotateX",
  panY: "rotateY",
  projection: am5map.geoOrthographic(),
  paddingBottom: 20,
  paddingTop: 20,
  paddingLeft: 20,
  paddingRight: 20
}));

var cont = chart.children.push(
  am5.Container.new(root, {
    layout: root.horizontalLayout,
    x: 20,
    y: 40
  })
);


var backgroundSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));
backgroundSeries.mapPolygons.template.setAll({
  fill: root.interfaceColors.get("alternativeBackground"),
  fillOpacity: 0,
  strokeOpacity: 0
});
backgroundSeries.mapPolygons.template.set("fillOpacity", 0);

backgroundSeries.data.push({
  geometry: am5map.getGeoRectangle(90, 180, -90, -180)
});

// Create main polygon series for countries

var polygonSeries = chart.series.push(
  am5map.MapPolygonSeries.new(root, {
    geoJSON: am5geodata_worldLow,
    exclude: ["antarctica"],
  })
);


var lineSeries = chart.series.push(am5map.MapLineSeries.new(root, {}));
lineSeries.mapLines.template.setAll({
  stroke: root.interfaceColors.get("alternativeBackground"),
  strokeOpacity: 0.3
});


var pointSeries = chart.series.push(am5map.MapPointSeries.new(root, {}));
var colorset = am5.ColorSet.new(root, {});

pointSeries.bullets.push(function () {
  var container = am5.Container.new(root, {});

  var circle = container.children.push(
    am5.Circle.new(root, {
      radius: 6,
      tooltipY: 0,
      fill: am5.color(0xff0000),
      strokeOpacity: 0,
      tooltipText: "{title}"
    })
  );

  var circle2 = container.children.push(
    am5.Circle.new(root, {
      radius:12,
      tooltipY: 0,
      fill: am5.color(0xff0000),
      strokeOpacity: 0,
      tooltipText: "{title}"
    })
  );

  circle.animate({
    key: "scale",
    from: 1,
    to: 4,
    duration: 600,
    easing: am5.ease.out(am5.ease.cubic),
    loops: Infinity
  });
  circle.animate({
    key: "opacity",
    from: 1,
    to: 0,
    duration: 3000,
    easing: am5.ease.out(am5.ease.cubic),
    loops: Infinity
  });

  return am5.Bullet.new(root, {
    sprite: container
  });
});

var regions = [
  
  
];

$(document).ready(function(){
  var region = $('#region').data();
var regionalValues = Object.values(region);

firstValue = regionalValues[0]
var splitValues = firstValue.split(":")
beforeTrim = splitValues[1];
finalRegion = beforeTrim.replace(/[^\w\s!?]/g,'');

if(finalRegion = "Western Africa"){
 regions.push({
    title: "West Africa",
    latitude: 9,
    longitude: 4
  },)
  addregion(regions[0].longitude, regions[0].latitude, regions[0].title);
  
}
})


function addregion(longitude, latitude, title) {
  pointSeries.data.push({
    geometry: { type: "Point", coordinates: [longitude, latitude] },
    title: title
  });
}


chart.appear(1000, 100);


}); 

    </script>
   
  </scripts>
  <style>

div#draw-shapes {
  width: 95%;
  height: 600px;
  margin: 2.5% auto;
}
    body{
      background-color: #eee;
    }
    .container-fluid {
   height: 100vh;
   width: 99%;
   background-color: #eee;
   display: grid;
   
  gap:5px ;
   grid-template-columns: repeat(4, 1fr);
   grid-template-rows: repeat(4, 1fr);
   
   

}

.container-fluid > div{
  box-shadow: 2px 2px 5px #333;
  padding: 20px;
 
  background-color: white;
}
.container-fluid > div:nth-child(1){
  
  grid-column: span 4;
  height: 100px;
  
}
.container-fluid > div:nth-child(2){
  height: 300px;
  grid-column: span 1;
  text-align: center;
}

.container-fluid > div:nth-child(3){
  
  grid-column: span 2;
  grid-row: span 2;
}
.container-fluid > div:nth-child(4){
  
  grid-column: span 1;
}
.container-fluid > div:nth-child(5){
  
  grid-column: span 1;
}
.container-fluid > div:nth-child(6){
  height: 300px;
  grid-column: span 1;
}
.container-fluid > div:nth-child(7){
  height: 210px;
  grid-column: span 4;
  position: relative;
}
.container-fluid .fa-solid{
            color: #add8e6;
            margin-top: 5px;
        }

.container2 {
  height: inherit;
  width: 33%;
  display: grid;
   
  margin-top: -10px;
  grid-template-columns: repeat(1, 1fr);
  grid-template-rows: repeat(3, 1fr);
}
        .container2 > div:nth-child(1){
  width:80%;
  height: 70%;
  grid-column-start: 1;
  grid-row-start: 1;
  
  position: relative;
}
.container2 > div:nth-child(2){
  width:80%;
  height: 70%;
  grid-column-start: 1;
  grid-row-start: 2;
  
  position: relative;
}
.container2 > div:nth-child(3){
  width:80%;
  height: 70%;
  grid-column-start: 1;
  grid-row-start: 3;
  position: relative;
  
}
.container3{
  clear: both;
  position: absolute;
  top:33%;
  right: -30%;
  width:100%
}

.btn-outline-success{
  background-color: #add8e6;
  color: #333;
  border-color: #add8e6 !important; 
  width:200px
}
.btn-outline-success:hover{
background-color: #35add4;
color: #eee !important;
  border-color: #35add4 !important; 
}


#chromosome01{
  position: absolute;
  top:2%;
  left:20%;
  font-size: 13px;
}
#chromosome02{
  position: absolute;
  top:2%;
  left:25.7%;
  font-size: 13px;
}
#chromosome03{
  position: absolute;
  top:2%;
  left:31.4%;
  font-size: 13px;
}
#chromosome04{
  position: absolute;
  top:2%;
  left:37.1%;
  font-size: 13px;
}
#chromosome05{
  position: absolute;
  top:2%;
  left:42.8%;
  font-size: 13px;
  
}
#chromosome06{
  position: absolute;
  top:2%;
  left:48.5%;
  font-size: 13px;
}
#chromosome07{
  position: absolute;
  top:2%;
  left:54.2%;
  font-size: 13px;
}
#chromosome08{
  position: absolute;
  top:2%;
  left:59.9%;
  font-size: 13px;
}
#chromosome09{
  position: absolute;
  top:2%;
  left:65.6%;
  font-size: 13px;
}
#chromosome10{
  position: absolute;
  top:2%;
  left:71.3%;
  font-size: 13px;
}
#chromosome11{
  position: absolute;
  top:2%;
  left: 77%;
  font-size: 13px;
}
#chromosome12{
  position: absolute;
  top:2%;
  left: 82.7%;
  font-size: 13px;
}
#chromosome13{
  position: absolute;
  top:2%;
  left:88.4%;
  font-size: 13px;
}
#chromosome14{
  position: absolute;
  top:2%;
  left:94.1%;
  font-size: 13px;
}

  </style>
  <script type="text/javascript">
$(document).ready(function(){
  var djangoData = $('#rvr-data').data();
dict = {}
for (var a in djangoData){
  var rvrValues = Object.values(djangoData);
  firstValue = rvrValues[0]
  
var splitValues = firstValue.split("{'chrom':")
var chromosomes = []

for(var i =1; i<splitValues.length;i++){
  var split2 =splitValues[i].split(",")

    var chromArray = split2[0].split("_");
    var resistancePosArray = split2[1].split(":")
    
    if (!(chromArray[1] in dict)) {
      dict[chromArray[1]] = [];
    }
    dict[chromArray[1]].push(resistancePosArray[1]);
  }
}
const keys =Object.keys(dict)
  for (var j =0;j<keys.length;j++){
    var chrom = keys[j]
  
    $("#chromosome"+chrom).show()
  }
});
  </script>
  
</head>
<div class="container-fluid">
  <div class="1">
    <h4><b>Result ID:</b> {{run_id}}</h4>
    <div class="date">
      {% for key in tables %}
      {% if key == 'General information' %}
      {{macros.get_results2(tables[key][0], tables[key][1], key)}}
      
      {% endif %}
      {% endfor %}              
    </div>
    <div class="id">
      <form method="get" action="{{ url_for('main.download', run_id=run_id) }}">          
      <button type="submit" class="btn btn-success btn" name="result_download" id="result_download"><i class="fa fa-download"></i> Download</button>
          
    </div>
  </div>
  
  <div class="2">
    
    {% for key in tables %}
    {% if key == 'Species' %}
    {{macros.get_results(tables[key][0], tables[key][1], key)}}
    
    {% endif %}
    {% endfor %}                 
  </div>
  <div class="3">
    <div class="row justify-content-center text-center">
      <div class="">    
        <div class="tab-content" id="tabcontent">  
          
          {% for key in tables %}     
            
              {% set keyname = key.replace(' ', '') %}
                {% if key == "Resistance report" %}
                <div class="tab-pane fade show active" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                  {{macros.generic_table(tables[key][0], tables[key][1], key)}}
                </div>       
            
                <div class="tab-pane fade" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                  {{macros.generic_table(tables[key][0], tables[key][1], key)}}
                </div>  
            {% endif %}
          {% endfor %}
        </div>
      </div>    
    </div>
  </div>
  <div class="4">
    <div class="card-header text-center bg-dark text-white">
      <h5>Region of Origin</h5>
  </div>
  {% for key in tables %}
    
    {% for row in tables[key][0] %}
    {% if key == 'Geoclassification' %}
    <meta id="region" data-name="{{row}}" >
    {% endif %}
    {% endfor %}
    {% endfor %}
    <div id="chartdiv" style="width: 100%; height: 75%;"></div></div>
  <div class="5">
    {% for key in tables %}
    {% if key == 'Analysis' %}
    {{macros.get_results(tables[key][0], tables[key][1], key)}}
    
    {% endif %}
    {% endfor %}  
  </div>
  <div class="6">{% for key in tables %}
    {% if key == 'Coverage report' %}
    {{macros.get_results(tables[key][0], tables[key][1], key)}}
    
    {% endif %}
    {% endfor %} </div>
  <div  class="7" id="7"> {% set values = [] %}
    <div class="container2">
      <div class="Resistance">
        <a type=button class="btn btn-outline-success btn-lg active" onclick="changeData()">Resistance variants</a>
        {% for key in tables %}
    
    {% for row in tables[key][0] %}
    {% if key == 'Resistance variants report' %}
    {{ values.append(row) or "" }}
   {% endif %}
    {% endfor %}
        
{% endfor %}
<meta id="rvr-data" data-name="{{values}}" >

      </div>
      <div class="otherVariants">
        <a  class="btn btn-outline-success btn-lg" onclick="changeData()">Other Variants</a>
        {% for key in tables %}
    
    {% for row in tables[key][0] %}
    {% if key == 'Other variants' %}
    {{ values.append(row) or "" }}
   {% endif %}
    {% endfor %}
        
{% endfor %}
        <meta id="other-data" data-name="{{values}}" >
      </div>
      <div class="Missing">
        <a  class="btn btn-outline-success btn-lg" onclick="changeData()">Missing Positions</a>
        {% for key in tables %}
    
    {% for row in tables[key][0] %}
    {% if key == 'Missing positions report' %}
    {{ values.append(row) or "" }}
   {% endif %}
    {% endfor %}
        
{% endfor %}
        <meta id="miss-data" data-name="{{values}}" >
      </div>
    </div>
    <div class="chromosomeList">
      
      {% for n in range(1,15) %}

      <div id="chromosome{{"%02.0f" % n}}" style="display: none; cursor: pointer;" onclick="drawChrom({{n}})" >Chromosome {{n}}</div>
      {% endfor %}
    </div>

      <div class="container3">
        <div  id="canvasForHTML"></div>  
      </div>
      
    
    
</div>

  
</div>
<script  type=text/javascript>
  $('.btn-outline-success').click(function(e) {
    e.preventDefault();
  console.log("ye")
  $('.btn-outline-success').removeClass('active');
  $(this).addClass('active');
})
</script>
<!--
  <div class="row justify-content-center text-center">
    <div class="col-md-6">
      <h4><b>Result ID:</b> {{run_id}}</h4>
        <div id="f3" class="row justify-content-center">
          <form method="get" action="{{ url_for('main.download', run_id=run_id) }}">          
          <button type="submit" class="btn btn-success btn-lg" name="result_download" id="result_download"><i class="fa fa-download"></i> Download</button>
          </form>
        </div>
        <hr>  
    </div>
  </div class="row justify-content-center text-center">
  
  <div class="row justify-content-center text-center">
    <div class="col-md-6">
      <ul class="nav nav-tabs" id="nav-tab" role="tablist">
        {% for key in tables %}
          {% if tables[key] != None %}
            {% set keyname = key.replace(' ', '') %}
              <li class="nav-item" role="presentation">
                {% if loop.index0 == 0 %}                    
                  <a class="nav-link active" id="{{ keyname }}-tab" data-toggle="tab" href="#{{ keyname }}-tabs" role="tab" aria-controls="{{ keyname }}-tabs" aria-selected="true">{{key}}</a>
                {% else %}
                  <a class="nav-link" id="{{ keyname }}-tab" data-toggle="tab" href="#{{ keyname }}-tabs" role="tab" aria-controls="{{ keyname }}-tabs" aria-selected="false">{{key}}</a>
                {% endif %}
              </li>
          {% endif %}            
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="row justify-content-center text-center">
    <div class="col-md-6">    
      <div class="tab-content" id="tabcontent">  
        {% for key in tables %}     
          {% if tables[key] != None %}         
            {% set keyname = key.replace(' ', '') %}
            {% if loop.index0 == 0 %}  
              <div class="tab-pane fade show active" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                {{macros.generic_table(tables[key][0], tables[key][1], key)}}
              </div>       
            {% elif loop.index0 != 0 %}
              <div class="tab-pane fade" id="{{ keyname }}-tabs" role="tabpanel" aria-labelledby="{{ keyname }}-tab">
                {{macros.generic_table(tables[key][0], tables[key][1], key)}}
              </div>  
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>    
  </div>
  
{% elif status == "Processing" %}
  <div class="row justify-content-center">
    <div class="loader"></div>
  </div>
  <div class="row justify-content-center">
    <h4 id="resultid">{{run_id}}</h4>

  -->
  <script>

    setTimeout(function(){
        window.location.reload(1);
    }, 5000);
  </script> 

{% endif %}
{% endblock %}